var emoji={"[大笑]":{file:"emoji_0.png"},"[可爱]":{file:"emoji_01.png"},"[色]":{file:"emoji_02.png"},"[嘘]":{file:"emoji_03.png"},"[亲]":{file:"emoji_04.png"},"[呆]":{file:"emoji_05.png"},"[口水]":{file:"emoji_06.png"},"[汗]":{file:"emoji_145.png"},"[呲牙]":{file:"emoji_07.png"},"[鬼脸]":{file:"emoji_08.png"},"[害羞]":{file:"emoji_09.png"},"[偷笑]":{file:"emoji_10.png"},"[调皮]":{file:"emoji_11.png"},"[可怜]":{file:"emoji_12.png"},"[敲]":{file:"emoji_13.png"},"[惊讶]":{file:"emoji_14.png"},"[流感]":{file:"emoji_15.png"},"[委屈]":{file:"emoji_16.png"},"[流泪]":{file:"emoji_17.png"},"[嚎哭]":{file:"emoji_18.png"},"[惊恐]":{file:"emoji_19.png"},"[怒]":{file:"emoji_20.png"},"[酷]":{file:"emoji_21.png"},"[不说]":{file:"emoji_22.png"},"[鄙视]":{file:"emoji_23.png"},"[阿弥陀佛]":{file:"emoji_24.png"},"[奸笑]":{file:"emoji_25.png"},"[睡着]":{file:"emoji_26.png"},"[口罩]":{file:"emoji_27.png"},"[努力]":{file:"emoji_28.png"},"[抠鼻孔]":{file:"emoji_29.png"},"[疑问]":{file:"emoji_30.png"},"[怒骂]":{file:"emoji_31.png"},"[晕]":{file:"emoji_32.png"},"[呕吐]":{file:"emoji_33.png"},"[拜一拜]":{file:"emoji_160.png"},"[惊喜]":{file:"emoji_161.png"},"[流汗]":{file:"emoji_162.png"},"[卖萌]":{file:"emoji_163.png"},"[默契眨眼]":{file:"emoji_164.png"},"[烧香拜佛]":{file:"emoji_165.png"},"[晚安]":{file:"emoji_166.png"},"[强]":{file:"emoji_34.png"},"[弱]":{file:"emoji_35.png"},"[OK]":{file:"emoji_36.png"},"[拳头]":{file:"emoji_37.png"},"[胜利]":{file:"emoji_38.png"},"[鼓掌]":{file:"emoji_39.png"},"[握手]":{file:"emoji_200.png"},"[发怒]":{file:"emoji_40.png"},"[骷髅]":{file:"emoji_41.png"},"[便便]":{file:"emoji_42.png"},"[火]":{file:"emoji_43.png"},"[溜]":{file:"emoji_44.png"},"[爱心]":{file:"emoji_45.png"},"[心碎]":{file:"emoji_46.png"},"[钟情]":{file:"emoji_47.png"},"[唇]":{file:"emoji_48.png"},"[戒指]":{file:"emoji_49.png"},"[钻石]":{file:"emoji_50.png"},"[太阳]":{file:"emoji_51.png"},"[有时晴]":{file:"emoji_52.png"},"[多云]":{file:"emoji_53.png"},"[雷]":{file:"emoji_54.png"},"[雨]":{file:"emoji_55.png"},"[雪花]":{file:"emoji_56.png"},"[爱人]":{file:"emoji_57.png"},"[帽子]":{file:"emoji_58.png"},"[皇冠]":{file:"emoji_59.png"},"[篮球]":{file:"emoji_60.png"},"[足球]":{file:"emoji_61.png"},"[垒球]":{file:"emoji_62.png"},"[网球]":{file:"emoji_63.png"},"[台球]":{file:"emoji_64.png"},"[咖啡]":{file:"emoji_65.png"},"[啤酒]":{file:"emoji_66.png"},"[干杯]":{file:"emoji_67.png"},"[柠檬汁]":{file:"emoji_68.png"},"[餐具]":{file:"emoji_69.png"},"[汉堡]":{file:"emoji_70.png"},"[鸡腿]":{file:"emoji_71.png"},"[面条]":{file:"emoji_72.png"},"[冰淇淋]":{file:"emoji_73.png"},"[沙冰]":{file:"emoji_74.png"},"[生日蛋糕]":{file:"emoji_75.png"},"[蛋糕]":{file:"emoji_76.png"},"[糖果]":{file:"emoji_77.png"},"[葡萄]":{file:"emoji_78.png"},"[西瓜]":{file:"emoji_79.png"},"[光碟]":{file:"emoji_80.png"},"[手机]":{file:"emoji_81.png"},"[电话]":{file:"emoji_82.png"},"[电视]":{file:"emoji_83.png"},"[声音开启]":{file:"emoji_84.png"},"[声音关闭]":{file:"emoji_85.png"},"[铃铛]":{file:"emoji_86.png"},"[锁头]":{file:"emoji_87.png"},"[放大镜]":{file:"emoji_88.png"},"[灯泡]":{file:"emoji_89.png"},"[锤头]":{file:"emoji_90.png"},"[烟]":{file:"emoji_91.png"},"[炸弹]":{file:"emoji_92.png"},"[枪]":{file:"emoji_93.png"},"[刀]":{file:"emoji_94.png"},"[药]":{file:"emoji_95.png"},"[打针]":{file:"emoji_96.png"},"[钱袋]":{file:"emoji_97.png"},"[钞票]":{file:"emoji_98.png"},"[银行卡]":{file:"emoji_99.png"},"[手柄]":{file:"emoji_100.png"},"[麻将]":{file:"emoji_101.png"},"[调色板]":{file:"emoji_102.png"},"[电影]":{file:"emoji_103.png"},"[麦克风]":{file:"emoji_104.png"},"[耳机]":{file:"emoji_105.png"},"[音乐]":{file:"emoji_106.png"},"[吉他]":{file:"emoji_107.png"},"[火箭]":{file:"emoji_108.png"},"[飞机]":{file:"emoji_109.png"},"[火车]":{file:"emoji_110.png"},"[公交]":{file:"emoji_111.png"},"[轿车]":{file:"emoji_112.png"},"[出租车]":{file:"emoji_113.png"},"[警车]":{file:"emoji_114.png"},"[自行车]":{file:"emoji_115.png"}};
var emojihtml = "";
var ids=[];
for (e in emoji) {
	emojihtml += `<li><a href="javascript:useEmoji('${e}');"><img src="images/emoji/${emoji[e].file}"></a></li>`;
}

//loadUser()
$.ajax({
	type : "GET",
	url : http+"/gobangteach/UserBaseController/getUserFullInfoById?userid="+uid+"&token="+token+"&uid="+uid,
	success : function(data) {
		var data = data.data.base;
			setCookie('uid',data.imAccid);
		
			setCookie('userid',data.id);
			setCookie('usertyp', data.usertype);
			setCookie('username', data.username);
            initNim();
       
	}
});


$("#emoji ul").html(emojihtml);
window.listJobQuestions = listJobQuestions;
/*数组去重*/
Array.prototype.distinct = function(){
	var arr = this,
		result = [],
		i,
		j,
		len = arr.length;
		for(i = 0; i < len; i++){
			for(j = i + 1; j < len; j++){
				if(arr[i] === arr[j]){
					j = ++i;
				}
			}
			result.push(arr[i]);
		}
	return result;
}

eve.on("nim_onConnect", function() {
	console.log("ON NIM Connected");
	//initRtc();
//    initRtcListener();
//initListeners();  //作业
	// check environment
	loadLiveInfo(function(data) {
		console.log("获得在线课堂信息：", data);
		
		if(data.classState == 2) {
			alert("该课程已结束");
		}
		
		if(data.classPassword) {
			window.classPassword = data.classPassword;
		}

		var myUserId = uid;
		var teacherId = data.userid;
		$("#headerImg").attr('src',data.classimg);
		$("#mask_title").html(data.classname);
		$("#teachName").html(data.username);
		if(data.classintro==''){
			$(".summary").text('简介:'+data.classname)
		}else{
			$(".summary").text('简介:'+data.classintro)
		}
		window.rtmpUrl = data.rtmpUrl;
		window.pullUrl = data.pullUrl;
		window.channel = data.channelName;

		if (myUserId == teacherId) {
			initTeacher();
		} else {
			initStudent();
		}

		initChatroom(data.chatroomId);
	});
});
$(function(){
	//点击作业题 增加对号,
	$('body').on('click','.imgBox',function(){
		var dataid = $(this).attr("data-id")
		if(!$(this).hasClass("active")){
			ids.push(dataid)
			ids = ids.distinct()
		}else{
			var x = ids.indexOf(dataid);
			ids.splice(x,1)
		}
		$(this).toggleClass("active");
		console.log('选中的题目id',ids.distinct())
	});

	$('body').on('click','.nextItem,.prevItem',function(){
		$('.imgBox').removeClass('active')	
	});
	//研讨
	$(".discuss").click(function(){
		if($(this).text()=='研讨'){
			$(this).text('结束研讨')
			eve.f("HadlerResearchPlayStart")();
			eve.f("HadlerTryPlayStart")();
		}else{
			$(this).text('研讨');
			eve.f("HadlerTryPlayEnd")();
			eve.f("HadlerResearchPlayEnd")();
			eve.f("HadlerGoToForward")();
		}
	});
	//棋谱
	$("#manualModal .modal-header div").click(function(){
		$(this).addClass('active').siblings().removeClass('active');
		var _index = $(this).index();
		$(".tab-content .chess").eq(_index).show().siblings('.chess').hide();
		if(_index==0){
			loadManual({userId:uid});
	    }else{
	    	loadManual({userId:''});
	    }
	});
	//上传
	$("#upload").on("change","input[type='file']",function(){
	    var filePath=$(this).val();
	    if(filePath.indexOf("sgf")!=-1){
	        var arr=filePath.split('\\');
	        var fileName=arr[arr.length-1];
	        $(".showFileName").val(fileName);
	    }else{
	        alert('文件格式错误,请上传正确的sgf格式的文件');
	        return false;
	    }
	    var file = event.target.files[0];
		var fileReader = new FileReader();
		var formDataArr = '';
		console.log(fileReader);

		var toBlob = function(a){
			return new Blob([a],{type:file.type})
		}
		fileReader.onload = function() {
			var result = this.result;
			var blob = new Blob([result],{type:file.type});
			var formData = new FormData();
			formDataArr = formData;
			 
			
			$("#fileUpdate").unbind().click(function(e){
				e.stopPropagation();
				formDataArr.append('sgf_file',blob,file.name);
		    	createGameFromSgf(formDataArr);
		    });
		};
		fileReader.readAsArrayBuffer(file);
		console.log('99999',fileReader)
	    
	});
	//加载题库
	$(".library").click(function(){
		layerOpen({area: ['13rem', '8.2rem'],content: $("#libraryModal")});
		listQuestions();
	});
	//changeChessboardModal 切换棋盘
	$(".changeChessboardModal").click(function(){
		layerOpen({area: ['7.22rem', '4.27rem'],skin:'change',content: $("#changeChessboardModal")});
	});
	//manualModal 棋谱
	$(".manualModal").click(function(){
		layerOpen({area: ['13rem', '8.2rem'],skin:'demo-open manual',content: $("#manualModal")});
		if($("#manualModal .modal-header div").eq(0).hasClass('active')){
			loadManual({userId:uid});
		}else{
			loadManual({userId:''});
		}
	});
	//clearboard 清空 
	$(".clearboard").click(function(){
		layerTC('您确定清空棋盘吗?',function(){clearChessboard()},layer.closeAll())
	});
	$(".board").click(function(){
		$(this).addClass('active').siblings().removeClass('active')
	})
});
//根据roomId进入直播  初始化
function loadLiveInfo(callback) {
	var roomId = Tool.queryString("roomId");
	//roomId = 227;
	console.log('444',Tool.queryString)
	$.ajax({
		type: "POST",
		url: http +"/gobangteach/classroom/getClassroomById",
		data : 'roomId=' + roomId+"&token="+token+"&uid="+uid,
		dataType: 'json',
		
		success: function(data) {
			if(callback) {
				callback(data.data);
			}
		},
		error: function(XMLHttpRequest,data) {
			alert("获取房间信息失败1");
		}
	});
}
//开始上课
function startClass($this) {
	var roomId = Tool.queryString("roomId");
	
	$.ajax({
		type: "POST",
		url: http + "/gobangteach/classroom/updateState",
		data : 'roomId=' + roomId + "&classState=" + 1+"&token="+token+"&uid="+uid,
		dataType: 'json',
		success: function(data) {
			startMasterLive(function() {
				window.classState = 1;
				sendText("开始上课");
				$("#start_tag").hide();
				clearChessboard();
				popStart();
			});
			$this.attr('disabled',true)
		},
		error: function(XMLHttpRequest,data) {
			alert("获取房间信息失败2");
		}
	});
}

//开始上课    老师 学生权限
function popStart() {
	$('#canvas_wrapper').canvasAlert({content:'开始上课'});
	$("#start_tag").hide();
}
function breakClass() {
	sendText("课件休息");
	popBreak();
}
function popBreak() {
	$("#alertNews").find('.classStop').show().siblings().hide();
	layerOpen({area: ['8rem', '3.2rem'],skin:'demo-open asw',content: $("#alertNews")});
	setTimeout(function(){
		layer.closeAll();
	}, 1000);
}
//落子投票
function discuss($this) {
	if($this.text()=='开始投票'){
		eve.f('HandlerTurnEditStatus')(13);
		$this.text('结束投票');
	}else{
		eve.f('HandlerDropVoteEnd')();
		$this.text('开始投票');
	}
	
}
//清空棋盘
function clearChessboard() {
	$.ajax({
		type: "POST",
		url: http +"/gobangteach/classroom/createGame",
		data : "size=" + window.currentSize+"&token="+token+"&uid="+uid,
		dataType: 'json',
		success: function(data) {
			console.log("ClearChessboard", data);
			window.currentGameId = data.data.chessid;
			eve.f("HandlerSignInReq", uid)();
			sendTipMsg("clear-chessboard", JSON.stringify({type:1, gameid:window.currentGameId}));
		},
		error: function(XMLHttpRequest,data) {
			alert("获取房间信息失败3");
		}
	});
}
//结束研讨
function playEnd(){
	eve.f("HadlerTryPlayEnd")();
	eve.f("HadlerResearchPlayEnd")();
	$('.discuss').removeClass('active').attr('src','img/ElecBoard/discuss.png');
}
//棋盘坐标
function toggleCoordinate() {
	if(window.coordShown) {
		eve.f("HandlerHideCoordinate")();
		window.coordShown = false;
	} else {
		eve.f("HandlerShowCoordinate")();
		window.coordShown = true;
	}
}
//切换棋盘
function changeChessboard() {
	if(document.getElementById("chessSize9").classList.contains('active')==true) {
		window.currentSize = 9;
	} else {
		window.currentSize = 19;
	}
	layer.closeAll();
	clearChessboard();
}
//直播通知  答对答错
function anwserRight() {
	sendText("答对");
	popRightboard();
}
//直播通知  答对答错
function anwserWrong() {
	sendText("答错");
	popWrongboard();
}
//答对
function popRightboard() {
    $('#canvas_wrapper').canvasAlert({content:'答对'});
}
//答错
function popWrongboard() {
    $('#canvas_wrapper').canvasAlert({content:'答错'});
}
//作业管理弹出框
function showJobWrapperModal() {
	vmJobWrapperModal.me = uid;
	vmJobWrapperModal.members = chatroom_data.members;
	console.log(chatroom_data)
	$("#job-wrapperModal").modal("show");
}
//显示手数
function toggleShowStep() {
	if(window.stepShown) {
		eve.f("HandlerHideStepTeach")();
		window.stepShown = false;
	} else {
		eve.f("HandlerShowStepTeach")();
		window.stepShown = true;
	}
}
//下课(退出房间)
function exitRoom() {
	if(vmChatroom.role == "teacher") {
		layerTC(
			'是否结束课堂？',
			function(){
				var roomId = Tool.queryString("roomId");
				$.ajax({
					type: "POST",
					url: http +"/gobangteach/classroom/updateState",
					data : 'roomId=' + roomId + "&classState=" + 2,
					dataType: 'json',
					success: function(data) {
						sendText("下课");
						window.setTimeout(function() {
							document.location.href = "myschema://go?a=1";
						}, 3000);
						closeDevice();// 关闭直播
					},
					error: function(XMLHttpRequest,data) {
						alert("获取房间信息失败4");
					}
				});
			},
			layer.closeAll()
		);
	} else {
		document.location.href = "myschema://go?a=1";
	}
}
	var vmChatroom = new Vue(
			{
				el : '#game_control_wrapper',
				data : {
					role : "student",
					msgs : [],
					members : [],
					
				},
				
				methods : {
					formatTime : function(time) {
						return DateFormat.format(new Date(time), 'hh:mm:ss');
					},
					formatId: function(msg){
						
						if(msg.from==uid&&msg.type=='tip'){
							return '1';
						}else if(msg.from==uid&&msg.type=='text'){
							return '2';//msg.type == 'text'
						}else if(msg.from!=uid&&msg.type=='text'){
							return '3';
						}else if(msg.from==uid&&msg.text==''){
							return '4'
						}
						
					},
					addToMyFriends : function(account) {
						nim_addFriend(account);
					},
					buildEmoji : function(text) {
						var re = /\[([^\]\[]*)\]/g;
						var matches = text.match(re) || [];
						for (var j = 0, len = matches.length; j < len; ++j) {
							if (emoji[matches[j]]) {
								text = text
										.replace(matches[j],
												'<img class="emoji" src="images/emoji/' + emoji[matches[j]].file + '" />');
							}
						}
						return text;
					},
					inviteNetcall : function(account) {
						if (liveStates == 0) {
							alert("请先开启直播");
						} else {
							console.log("invite-netcall", account);
							sendTipMsg("invite-netcall", JSON.stringify({
								type : 1,
								account : account
							}), account, function() {
								alert("邀请已发送");
							});
						}
					},
					cancelNetcall : function(account) {
						if (liveStates == 0) {
							alert("请先开启直播");
						} else {
							console.log("cancel-netcall", account);
							sendTipMsg("cancel-netcall", JSON.stringify({
								type : 1,
								account : account
							}), account, function() {
							});
						}
					}
				},
				updated: function() {
					this.$nextTick(function(){
						var div = document.getElementById('chat-wrapper');
						div.scrollTop = div.scrollHeight;
					});
				}
			});


	//棋谱
	var vmManualModal = new Vue({
		el : "#manualModal",
		data : {
				pageinfo: {
					list: []
				},
				pageinfoOther: {
					list: []
				}
		},
		methods : {
			loadChess : function(chessId) {
				$.ajax({
					type : "POST",
					url : http +"/gobangteach/classroom/loadChess",
					data : "chessid=" + chessId+"&token="+token+"&uid="+uid,
					dataType : 'json',
					success : function(data) {
						console.log("loadChess", data);
						window.currentGameId = data.data.chessid;
						eve.f("HandlerSignInReq", uid)();
						sendTipMsg("clear-chessboard", JSON.stringify({
							type : 1,
							gameid : window.currentGameId
						}));
						playEnd();
						layer.closeAll();
					},
					error : function(XMLHttpRequest, data) {
						layerTC("获取房间信息失败5");
					}
				});
			},
			formatTime : function(time) {
				return DateFormat.format(new Date(time), 'yyyy-MM-dd hh:mm:ss');
			},
			page: function (pageNum) {
                var pageinfo = this.pageinfo;
                console.log(pageinfo);
                if($("#manualModal .modal-header div").eq(0).hasClass('active')){
                	loadManual({
	                	userId:uid,
	                	pageNum: pageNum,
	                	id:dataMsg[0].value,
						name:dataMsg[1].value,
						startTime:dataMsg[2]?dataMsg[0].value.split(' - ')[0]:'',
						endTime:dataMsg[2]?dataMsg[0].value.split(' - ')[1]:'',
                	});
                }else{
                	loadManual({ 
	                	pageNum: pageNum,
	                	id:dataMsg[0].value,
						name:dataMsg[1].value,
						startTime:dataMsg[2]?dataMsg[0].value.split(' - ')[0]:'',
						endTime:dataMsg[2]?dataMsg[0].value.split(' - ')[1]:'',
                	});
                }
            },
            formatResult:function (res){
                 return res == 1 ? "黑棋胜" : res == 2 ? "白棋胜" : res == 3 ? "平局"  : "";
            }
		}
	});
	var vm = new Vue({
		el : "#libraryModal",
		data : {
			pageinfo: {
				list: []
			},
            listKnowledge: {
                list: ''
            },
            
		},
		methods : {
		loadQuestion : function(questionId,flag) {
				if(flag==0){
					loadQuestionDemo(questionId);
					layer.closeAll();
				}else{
					loadQuestionDemo(questionId);
				}
				
			},
			refresh: function(pageNum) {

				var pageinfo = this.pageinfo;
				if (pageinfo.hasNextPage) {
					listQuestions({pageNum: pageNum});
                } else {
                	listQuestions({pageNum: pageNum});
                }
			}
		}
		
	});
	
	var vmJobModal = new Vue({
		el : "#workManage", //作业缩略图
		data : {
			pageinfo: {
				list: []
			},
            listKnowledge: {
                list: ''
            }
		},
		methods : {
			loadQuestion : function(questionId,flag) {
				if(flag==0){
					loadQuestionDemo(questionId);
					$("#job-wrapperModal").modal('hide');
				}else{
					loadQuestionDemo(questionId);
				}
				
			},
			refresh: function() {

				var pageinfo = this.pageinfo;
				if(pageinfo.hasNextPage) {
					listQuestions({pageNum: pageinfo.firstPage});
				} else {
					listQuestions({pageNum: pageinfo.nextPage});
				}
			}
		}
		
	});
	
	var vmHistoryJob = new Vue({
        el: "#mainWrapper",
        data: {
            pageinfo: {
                list: []
            }
        },
        methods: {
            searchJob: function () {
            	
            	loadhistoryJob();
            },
            locationMyJob :function(time){
            	setCookie('historyJobTime', time);
            	window.location.href="mineHomework.jsp";
            },
            page: function () {
                var pageinfo = this.pageinfo;
                console.log(pageinfo);
                loadhistoryJob({ pageNum: pageNum});
            },
            formatTime: function (time) {
                 return DateFormat.format(new Date(time), 'yyyy-MM-dd hh:mm:ss');
            }
           
        }

    });
	//棋谱
	function loadManual(condition) {
		var params = condition || {};
		params.pageNum = params.pageNum || 1;
		params.pageSize = 5;
		params.token = token;
		params.uid = uid;
		$.ajax({
			url : http +'/gobangteach/classroom/listChesses',
			type : "POST",
			dataType : "jsonp",
			data : $.param(params),
			success : function(data) {
				console.log("list chesses", data)
				vmManualModal.pageinfo = data.data;
			}
		});
	}
	//双击点击习题
	function loadQuestionDemo(questionId){
		$.ajax({
			type : "POST",
			url : http +"/gobangteach/classroom/loadQuestionDemo",
			data : "questionid=" + questionId+"&token="+token+"&uid="+uid,
			dataType : 'json',
			success : function(data) {
				console.log("loadQuestion", data);
				window.currentGameId = data.data.chessid;
				eve.f("HandlerSignInReq", uid)();
				sendTipMsg("clear-chessboard", JSON.stringify({
					type : 1,
					gameid : window.currentGameId
				}));
			},
			error : function(XMLHttpRequest, data) {
				alert("获取习题失败");
			}
		});
	}
	//加载题库
	function listQuestions(condition) {
         var params = condition || {};
         params.pageNum = params.pageNum || 1;
		 var questionType = $("#gobangType").val();
		 var level = $("#gobangLevel option:selected").text()
		 var QuestionName = $("#knowledge option:selected").text();
		 params = {
		 		pageNum:1,
				pageSize:12,
				questionType:questionType, //类型
				level:level,   //棋力等级
				QuestionName:QuestionName, //知识点
		 }
         $.ajax({
             url: http +'/gobangteach/classroom/searchQuestions',
             type: "POST",
             timeout: 5000,
             dataType: "json",
             data: $.param(params),
             success: function (data) {
                 console.log("----------------------");
                 console.log(data.data);
                 if(data.data.list.length==0){
                 	$("#content-body,.modal-footer,aside").hide();
         			$("#libraryModal #noDetail").show();
                 	$.ajax({
                 		type: "POST",
                 		url: "http +/gobangteach/classroom/createGame",
                 		data : "size=" + 19,
                 		dataType: 'json',
                 		success: function(data) {
                 			console.log("ClearChessboard", data);
                 			window.currentGameId = data.data.chessid;
                 			eve.f("HandlerSignInReq", uid)();
                 		},
                 		error: function(XMLHttpRequest,data) {
                 			alert("获取房间信息失败6");
                 		}
                 	});
                 }else{
                 	$("#content-body,.modal-footer,aside").show();
         			$("#libraryModal #noDetail").hide();
         			 //vm.loadQuestion(data.data.list[0].id);
                     vm.pageinfo = data.data;
                     //vmJobModal.loadQuestion(data.data.list[0].id);
                     vmJobModal.pageinfo= data.data;
                     $('.imgBox').removeClass('active')
                     ids=[]
                 }
             }
         });
     }
     //习题 根据类型查知识点
     function selectType($this,flag){
    	if(flag==0){
    		if($this.val()==0&&$this.attr('id')=='gobangType'){
         		$("#knowledge").attr('disabled','disabled');
         	}else if($this.val()!=0&&$this.attr('id')=='gobangType'){
         		$("#knowledge").attr('disabled',false);
         	}
    		selectListKnowledge(0);
    	}else{
    		if($this.val()==0&&$this.attr('id')=='jobGobangType'){
         		$("#questionname").attr('disabled','disabled');
         	}else if($this.val()!=0&&$this.attr('id')=='jobGobangType'){
         		$("#questionname").attr('disabled',false);
         	}
    		selectListKnowledge(1);
    	}
     }
     //习题搜索知识点   flag 0:题库 1:作业中
     function selectListKnowledge(flag){
   	 	if(flag==0){
	   	 	var questionType = $("#gobangType").val();
			var level = $("#gobangLevel option:selected").text();
			var params = {
				questionType:questionType, //类型
				level:level,   //棋力等级
			}
			$.ajax({
	     		type: "GET",
	     		url: http +"/gobangteach/classroom/listKnowledge",
	     		data : $.param(params),
	     		dataType: 'json',
	     		success: function(data) {
	     			console.log('知识点1',data);
	     			vm.listKnowledge = data.data;
	     		},
	     		error: function(XMLHttpRequest,data) {
	     			alert("查询知识点失败");
	     		}
	     	});
   	 	}else{
	   	 	var questionType = $("#jobGobangType").val();
			var level = $("#jobGobangLevel option:selected").text();
			var params = {
				questionType:questionType, //类型
				level:level,   //棋力等级
			}
			$.ajax({
	     		type: "GET",
	     		url: http +"/gobangteach/classroom/listKnowledge",
	     		data : $.param(params),
	     		dataType: 'json',
	     		success: function(data) {
	     			console.log('知识点2',data);
	     			vmJobModal.listKnowledge = data.data;
	     		},
	     		error: function(XMLHttpRequest,data) {
	     			alert("查询知识点失败");
	     		}
	     	});
   	 	}
    	
     }
     //搜索作业详情
     function loadJobDetail(){
    	 //$("#job-wrapperModal").modal('show');
    	 var params = {};
		 var questionType = $("#jobGobangType").val();
		 var level = $("#jobGobangLevel option:selected").text();
		 var QuestionName = $("#questionname option:selected").val();
		 params = {
		 		pageNum:1,
				pageSize:8,
				questionType:questionType, //类型
				level:level,   //棋力等级
				QuestionName:QuestionName, //知识点
		 }
		 listQuestions(params)
     }
     //历史作业
     function loadhistoryJob(condition) {
	    	var jobStartTime = $("#jobStartTime").val();
			var jobEndTime = $("#jobEndTime").val();
	    	var params = condition || {};
	        params =  {
	        		pageNum:1,
	        		pageSize:10,
	        		startTime:jobStartTime,
	        		endTime:jobEndTime
	        };
	        params.pageNum = params.pageNum || 1;
	        $.ajax({
	            url: http +'/gobangteach/classroom/historyJob',
	            type: "POST",
	            timeout: 5000,
	            dataType: "jsonp",
	            data: $.param(params),
	            success: function (data) {
	                console.log("----------------------------------------------");
	                console.log(data);
	                //vm.loadQuestion(data.data.list[0].QuestionID);
	                vmHistoryJob.pageinfo = data.data; 
	
	            }
	        });
	    }
     function saveJob() {
 		
 		
 		var accounts = vmJobWrapperModal.$data.dx; //学员id
 		var questionIds = ids.distinct();	//作业 id
 		if(accounts.length<=0){
 			alert('请选择学员')
 		}else if(questionIds<=0){
 			alert('请选择作业题')
 		}else{
 			
 			console.log(accounts.toString(),'===',questionIds.toString())
 			
 			var params = {
 				questionIds: questionIds.toString(),
 				accounts:accounts.toString()
 			}
 			
 			$.ajax({
 				url : http +'/gobangteach/classroom/createJobs',
 				type : "POST",
 				timeout : 5000,
 				dataType : "jsonp",
 				data : $.param(params),
 				success : function(data) {
 					alert("作业布置成功。");
 			        $("#job-wrapperModal").modal('hide');
 			        //成功后清空页面数据
 			        ids =[];
 			        vmJobWrapperModal.$data.dx = '';
 			        $('.imgBox').removeClass('active')
 				}
 			});
 			
 		}
 	}

     function listJobQuestions() {
 		var params = {};
 		params.pageNum = params.pageNum || 1;
 		params.pageSize = 999;

 		params.questiontype = $("#questiontype").val();
 		params.questionname = $("#questionname").val();
 		params.suggestlevel = $("#suggestlevel").val();
 		//params.opencond = $("#opencond").val(),
 		params.opencond = 1;

 		$.ajax({
 			url : http +'/gobangteach/classroom/listQuestions',
 			type : "POST",
 			timeout : 5000,
 			dataType : "jsonp",
 			data : $.param(params),
 			success : function(data) {
 				console.log("list questions", data)
 				vmWorkManager.list = data.data.list;
 			}
 		});
 	}
   //上传 upload
 	function upload($this){
 		var flag = $this.attr('flag');
 		layer.closeAll();
 		$(".showFileName,#upTitle,.file_input").val('');
 		if(flag=='0'){
 			$(".modal-body>div").eq(1).hide();
 			$(".modal-body>div").first().css('padding','0.4rem 0px 1.1rem');
 		}else{
 			$(".modal-body>div").eq(1).show();
 			$(".modal-body>div").first().css('padding','0 0 0.6rem');
 		}
 		layerOpen({area: ['7.99rem', '4.27rem'],skin:'upload',content: $("#upload")});
 	}
 	function createGameFromSgf(formData) {
 		//console.log(formData.entries());
 		$.ajax({
             type:"post",
             url:http +"/gobangteach/classroom/createGameFromSgf",
             async: false,
             contentType: false, // 注意这里应设为false
             processData: false,
             data: formData,
 			cache: false,
             timeout: 6000,
             success: function (data) {
             	console.log("load sgf done", data);
             	layer.closeAll();
             	var msg = data.error.returnMessage;
             	layerTC(msg);
 				window.currentGameId = data.data.chessid;
 				eve.f("HandlerSignInReq", uid)();
 				playEnd();
             }
         });
 	}
	//listQuestions();
	//loadJobDetail();
	//loadhistoryJob();
	
	
	
	eve.on("nim_onConnect", function() {
		
		console.log('mmmmmmm',nim_instance)
		nim_instance.getUsers({accounts: ['408612ad81c945f791f13a29593e9d01'], done: function(err, list) {
			/* var acc = [];
			$.each(list,function(){
				
			}) */
			
			console.log('dddd',list)
		}});
		
	})
/* 作业管理部分 */

/* ./作业管理部分 */	
